# AIminer v1.20-SNAPSHOT 変更レポート

**日付**: 2025-11-27
**バージョン**: 1.17-SNAPSHOT → 1.20-SNAPSHOT

## 概要

AIボットの視覚システムを大幅に改善し、周囲の状況認識精度を向上させました。

## 問題点（修正前）

ログ分析により以下の問題が確認されました：

1. **周囲ブロックの誤認識**: 岩盤(BEDROCK)ばかりがAIに送信され、「岩盤だらけ」と誤認
2. **座標のズレ**: メモリの古い位置情報を参照し、リアルタイム座標と乖離
3. **インベントリ把握不足**: 装備品のみ取得、実際の所持アイテムを認識できず
4. **周囲アイテムの検出なし**: ドロップアイテムを一切認識できない
5. **プレイヤー位置の検出なし**: 近くのプレイヤーを認識できない

## 変更内容

### 1. VisionScanner.java - ブロック検知の最適化

**新規追加**: ブロックフィルタリングシステム

```java
// 無視するブロック（情報価値が低い）
IGNORED_BLOCKS = {AIR, CAVE_AIR, VOID_AIR, BEDROCK, GRASS_BLOCK, DIRT, ...}

// 重要なブロック（優先的に報告）
IMPORTANT_BLOCKS = {OAK_LOG, SPRUCE_LOG, ..., COAL_ORE, IRON_ORE, ..., CHEST, CRAFTING_TABLE, ...}
```

- BEDROCK等の掘れないブロックを除外
- LOG、ORE等の重要ブロックを優先（最大30件）
- 通常ブロックは最大20件に制限
- 距離順にソート（近いものを優先）

### 2. VisionScanner.java - アイテム・プレイヤー検出機能追加

**新規メソッド**:
- `scanItems()`: 周囲のドロップアイテムを検出
- `scanPlayers()`: 周囲のプレイヤーを検出

各エンティティの座標と距離を記録し、AIが「MOVE_TOでアイテムを拾いに行く」判断が可能に。

### 3. BlockVisionData.java - 新フィールド追加

```java
private List<VisibleEntity> nearbyItems;      // ドロップアイテム
private List<VisibleEntity> nearbyPlayers;    // 近くのプレイヤー
private Position botPosition;                  // ボットの現在位置（リアルタイム）
```

### 4. VisibleEntity.java - 新規モデルクラス

アイテムやプレイヤーの情報を格納するクラスを追加：
- worldPosition: ワールド座標
- entityType: "ITEM" or "PLAYER"
- name: アイテム名/プレイヤー名
- count: スタック数
- distance: ボットからの距離

### 5. AIServerClient.java - AI向けメッセージ改善

**現在位置**: Vision scanからリアルタイムで取得（メモリに依存しない）

**新しい情報セクション**:
```
**周囲のアイテム（拾える）**:
  - OAK_LOG x2 (-24.5, -58.0, 1.2) 距離:2.3
  ※MOVE_TOで近づくと自動で拾えます

**周囲のプレイヤー**:
  - imuzen127 (-20.0, -57.0, 3.0) 距離:5.1
```

**システムプロンプト更新**:
- アイテム拾いの説明を追加
- MOVE_TOコマンドの用途を明記

### 6. TaskExecutor.java - インベントリ取得改善

装備品の詳細情報を取得し、空の場合は「empty」と記録。

## ログ出力の変更

修正前:
```
Vision scan completed: 509 blocks found (radius: 10)
```

修正後:
```
Vision scan completed: 25 blocks, 3 items, 1 players (radius: 10)
```

## 期待される効果

1. **正確な状況認識**: 岩盤を無視し、木や鉱石を優先的に報告
2. **リアルタイム座標**: 常に最新の位置情報をAIに送信
3. **アイテム回収**: ドロップアイテムを認識し、拾いに行ける
4. **プレイヤー追跡**: 近くのプレイヤー位置を把握
5. **効率的な情報量**: 重要な情報に絞ることでLLMの処理効率向上

## ファイル変更一覧

| ファイル | 変更種別 |
|---------|---------|
| plugin/AIminer/build.gradle | 修正 (version) |
| plugin/AIminer/src/.../model/VisibleEntity.java | 新規作成 |
| plugin/AIminer/src/.../model/BlockVisionData.java | 修正 |
| plugin/AIminer/src/.../vision/VisionScanner.java | 大幅修正 |
| plugin/AIminer/src/.../executor/TaskExecutor.java | 修正 |
| plugin/AIminer/src/.../ai/AIServerClient.java | 修正 |

## ビルド成果物

- `AIminer-1.20-SNAPSHOT.jar` (約3.5MB)
