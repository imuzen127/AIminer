# AIminer v1.21-SNAPSHOT 変更レポート

**日付**: 2025-12-02
**バージョン**: 1.20-SNAPSHOT → 1.21-SNAPSHOT

## 概要

インベントリ取得とアイテムエンティティ検出を、Minecraftの`/data get entity`コマンド経由に変更しました。これにより、Bukkit APIでは取得できなかったNBTデータを正確に取得できるようになりました。

## 問題点（修正前）

1. **インベントリが把握できない**: Bukkit APIの`getEquipment()`では装備品のみ取得可能で、ゾンビピグリンのインベントリ（HandItems等）が取得できなかった
2. **アイテムエンティティの検出が不完全**: `world.getNearbyEntities()`では動作したが、より正確な座標と種類の取得が必要だった

## 解決方法

Minecraftのdataコマンドを使用してNBTデータを直接取得：

```
/data get entity @e[tag=test1,limit=1] Inventory
/execute as @e[tag=test1,limit=1] run data get entity @n[type=item] Pos
/execute as @e[tag=test1,limit=1] run data get entity @n[type=item] Item
```

## 変更内容

### 1. CommandResultCapture.java（新規）

NBTデータをパースするユーティリティクラス：

```java
// インベントリアイテムのパターン: {id: "minecraft:oak_log", count: 2}
private static final Pattern ITEM_PATTERN = Pattern.compile(
    "\\{id:\\s*\"minecraft:([^\"]+)\",\\s*count:\\s*(\\d+)"
);

// 座標のパターン: [-24.5d, -58.0d, 1.2d]
private static final Pattern POS_PATTERN = Pattern.compile(
    "\\[(-?[\\d.]+)d?,\\s*(-?[\\d.]+)d?,\\s*(-?[\\d.]+)d?\\]"
);
```

### 2. DataCommandListener.java（新規）

サーバーログからコマンド結果をキャプチャするリスナー：

- `captureInventory(botTag)` - インベントリ取得
- `captureNearbyItemPos(botTag)` - 近くのアイテム座標取得
- `captureNearbyItemType(botTag)` - 近くのアイテム種類取得
- `captureNearbyItem(botTag)` - 座標と種類を両方取得

### 3. TaskExecutor.java（修正）

インベントリ取得をコマンド経由に変更：

```java
// 修正前: Bukkit API
botEntity.getEquipment().getItemInMainHand();

// 修正後: dataコマンド経由
List<CommandResultCapture.InventoryItem> items =
    dataCommandListener.captureInventory(BOT_FEET_TAG);
```

### 4. VisionUpdateTask.java（修正）

アイテムエンティティ検出をコマンド経由に追加：

```java
private List<VisibleEntity> captureNearbyItems() {
    CommandResultCapture.NearbyItem nearbyItem =
        dataCommandListener.captureNearbyItem(BOT_FEET_TAG);
    // ...
}
```

### 5. AIminer.java（修正）

DataCommandListenerの初期化と登録を追加。

## ファイル変更一覧

| ファイル | 変更種別 |
|---------|---------|
| plugin/AIminer/build.gradle | 修正 (version) |
| plugin/AIminer/src/.../util/CommandResultCapture.java | 新規作成 |
| plugin/AIminer/src/.../listener/DataCommandListener.java | 新規作成 |
| plugin/AIminer/src/.../AIminer.java | 修正 |
| plugin/AIminer/src/.../executor/TaskExecutor.java | 修正 |
| plugin/AIminer/src/.../vision/VisionUpdateTask.java | 修正 |

## 期待される効果

1. **正確なインベントリ認識**: ボットが持っているアイテムを正確に把握
2. **ドロップアイテムの検出**: 近くに落ちているアイテムの座標と種類を取得
3. **AIへの正確な情報提供**: より正確な状況認識が可能に

## ログ出力例

修正後のログ出力：
```
[INFO] Inventory captured via command: [oak_log x2, cobblestone x64]
[INFO] Nearby item detected via command: oak_log x1 at (-24.5, -58.0, 1.2)
```

## 技術的な注意点

- コマンド結果はサーバーログにのみ出力されるため、Loggerハンドラでキャプチャ
- 非同期処理のため、結果取得に50msの待機を入れている
- パターンマッチングでNBT形式をパース

## ビルド成果物

- `AIminer-1.21-SNAPSHOT.jar` (約3.5MB)
